image: docker:24.0.5

services:
  - docker:24.0.5-dind

variables:
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - build
  - test
  - deploy

# --- CONSTRUCTION DU BACKEND ---
build_backend:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:latest
  rules:
    - changes:
        - backend/**/*

# --- CONSTRUCTION DU FRONTEND ---
build_frontend:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  rules:
    - changes:
        - frontend/**/*

# --- TEST DE CONFORMITÉ (EXIGENCE PORT 80) ---
test_frontend:
  stage: test
  script:
    - apk add --no-cache curl
    # On lance l'image du front qui doit écouter sur le port 80
    - docker run -d --name test-front -p 80:80 $CI_REGISTRY_IMAGE/frontend:latest
    - sleep 10
    # On vérifie que le serveur répond (le conteneur dind utilise l'alias 'docker')
    - curl --retry 3 --retry-delay 5 http://docker:80
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# --- DÉPLOIEMENT AUTOMATIQUE ---
deploy_esiea:
  stage: deploy
  script:
    - apk add --no-cache curl
    - |
      curl -X POST https://esiea.cloud/api/deploy/restart \
      -H "Authorization: Bearer $ESIEA_CLOUD_TOKEN" \
      -H "Content-Type: application/json"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"